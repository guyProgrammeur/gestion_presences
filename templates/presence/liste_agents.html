{% extends "presence/base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto mt-1">
    <div class="flex justify-between items-center mb-1">
        <h2 class="text-2xl font-bold text-blue-900">Liste des Agents</h2>
        <a href="{% url 'admin:presence_agent_add' %}" class="bg-blue-700 hover:bg-blue-900 text-white font-semibold px-5 py-2 rounded-lg shadow transition">
            Ajouter un agent
        </a>
    </div>

    <form method="get" class="flex flex-wrap items-center gap-4 mb-8 bg-gray-50 p-6 rounded-lg shadow">
        <input 
            type="text" 
            name="search" 
            placeholder="Recherche..." 
            value="{{ search_query }}"
            class="px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400 min-w-[180px]"
        />

        <select 
            name="division" 
            id="division-select"
            class="px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400"
        >
            <option value="all">-- Toutes les divisions --</option>
            {% for division in divisions %}
                <option value="{{ division.id }}" {% if division.id|stringformat:"s" == selected_division %}selected{% endif %}>
                    {{ division.nom }}
                </option>
            {% endfor %}
        </select>

        <select 
            name="bureau" 
            id="bureau-select"
            class="px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400"
        >
            <option value="all">-- Tous les bureaux --</option>
            {% for bureau in bureaux %}
                <option value="{{ bureau.id }}" data-division="{{ bureau.division.id }}"
                    {% if bureau.id|stringformat:"s" == selected_bureau %}selected{% endif %}>
                    {{ bureau.nom }}
                </option>
            {% endfor %}
        </select>

        <button 
            type="submit"
            class="bg-blue-700 hover:bg-blue-900 text-white font-semibold px-6 py-2 rounded transition"
        >
            Filtrer
        </button>
    </form>

    <div class="overflow-x-auto rounded-lg shadow-sm">
    <table class="min-w-full bg-white text-sm">
        <thead class="bg-gray-50 border-b border-gray-200 text-gray-600 uppercase tracking-wider">
            <tr>
                <th scope="col" class="py-3 px-4 text-left font-medium">Matricule</th>
                <th scope="col" class="py-3 px-4 text-left font-medium">Agent</th>
                <th scope="col" class="py-3 px-4 text-left font-medium">Grade</th>
                <th scope="col" class="py-3 px-4 text-left font-medium">Service</th>
                <th scope="col" class="py-3 px-4 text-left font-medium">Sexe</th>
                <th scope="col" class="py-3 px-4 text-right font-medium">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for agent in page_obj %}
            <tr class="hover:bg-gray-50 transition-colors duration-200 ease-in-out border-b border-gray-100 last:border-b-0">
                <td class="py-3 px-4 text-gray-500">{{ agent.matricule }}</td>
                <td class="py-3 px-4 font-medium text-gray-800">
                    <div class="flex items-center gap-3">
                        {% if agent.photo %}
                        <img class="w-8 h-8 rounded-full object-cover" src="{{ agent.photo.url }}" alt="Photo de {{ agent.nom_complet }}">
                        {% endif %}
                        <a href="{% url 'presence:details_agent' agent.id %}" class="text-gray-900 hover:text-blue-600 hover:underline">
                            {{ agent.nom_complet }}
                        </a>
                    </div>
                </td>
                <td class="py-3 px-4 text-gray-500">{{ agent.grade }}</td>
                <td class="py-3 px-4 text-gray-500">{{ agent.Division_Bureau.nom }}</td>
                <td class="py-3 px-4">
                    {% if agent.sexe == 'M' %}
                    <span class="inline-flex items-center gap-1.5 rounded-full bg-blue-100 px-2.5 py-1 text-xs font-semibold text-blue-700">
                        <svg class="h-2 w-2 fill-current" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3" /></svg>
                        Masculin
                    </span>
                    {% else %}
                    <span class="inline-flex items-center gap-1.5 rounded-full bg-pink-100 px-2.5 py-1 text-xs font-semibold text-pink-700">
                        <svg class="h-2 w-2 fill-current" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3" /></svg>
                        Féminin
                    </span>
                    {% endif %}
                </td>
                <td class="py-3 px-4 text-right whitespace-nowrap">
                    <a href="{% url 'admin:presence_agent_change' agent.id %}" class="text-indigo-600 hover:text-indigo-800 hover:underline mr-3 font-medium transition-colors">Modifier</a>
                    <a href="{% url 'presence:gestion_presences' %}?agent_id={{ agent.id }}" class="text-green-600 hover:text-green-800 hover:underline font-medium transition-colors">Présence</a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="text-center text-gray-500 py-4">
                    Aucun agent trouvé
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

    {% if page_obj.paginator.num_pages > 1 %}
    <div class="flex items-center justify-between mt-6">
        <div class="text-sm text-gray-600">
            Affichage de <span class="font-semibold">{{ page_obj.start_index }}</span> à 
            <span class="font-semibold">{{ page_obj.end_index }}</span> sur 
            <span class="font-semibold">{{ page_obj.paginator.count }}</span> agents
        </div>
        <div class="flex gap-2">
            {% if page_obj.has_previous %}
            <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_division %}&division={{ selected_division }}{% endif %}{% if selected_bureau %}&bureau={{ selected_bureau }}{% endif %}" 
               class="bg-gray-300 text-gray-800 px-3 py-1 rounded hover:bg-gray-400">Première</a>
            <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_division %}&division={{ selected_division }}{% endif %}{% if selected_bureau %}&bureau={{ selected_bureau }}{% endif %}" 
               class="bg-gray-300 text-gray-800 px-3 py-1 rounded hover:bg-gray-400">Précédent</a>
            {% endif %}
            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded">{{ page_obj.number }}</span>
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_division %}&division={{ selected_division }}{% endif %}{% if selected_bureau %}&bureau={{ selected_bureau }}{% endif %}" 
               class="bg-gray-300 text-gray-800 px-3 py-1 rounded hover:bg-gray-400">Suivant</a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_division %}&division={{ selected_division }}{% endif %}{% if selected_bureau %}&bureau={{ selected_bureau }}{% endif %}" 
               class="bg-gray-300 text-gray-800 px-3 py-1 rounded hover:bg-gray-400">Dernière</a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const divisionSelect = document.getElementById('division-select');
            const bureauSelect = document.getElementById('bureau-select');

            function filterBureaux() {
                const selectedDivision = divisionSelect.value;
                const bureauOptions = bureauSelect.querySelectorAll('option');

                bureauOptions.forEach(opt => {
                    const divId = opt.getAttribute('data-division');
                    if (!divId || selectedDivision === "all" || divId === selectedDivision) {
                        opt.hidden = false;
                    } else {
                        opt.hidden = true;
                        if (opt.selected) {
                            opt.selected = false;
                        }
                    }
                });
            }

            divisionSelect.addEventListener('change', filterBureaux);
            filterBureaux(); // au chargement
        });
    </script>
</div>
{% endblock %}